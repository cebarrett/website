---
- hosts: all
  remote_user: root
  tasks:
    - name: update apt
      apt: update_cache=yes cache_valid_time=3600
    - name: upgrade packages
      apt: upgrade=yes
    - name: install dependencies
      apt: pkg={{item}} state=latest
      with_items:
      - zip
      - unzip
      - openjdk-7-jdk
      - libjansi-java
    - name: configure iptables
      template: src=templates/iptables.j2 dest=/etc/iptables.rules
      notify:
      - restore iptables
    - name: install fail2ban
      apt: pkg=fail2ban state=latest
      notify:
      - restart fail2ban
    - name: upgrade nginx
      apt: pkg=nginx state=latest
      notify:
      - restart nginx
    - name: download scala
      get_url: url=http://www.scala-lang.org/files/archive/scala-2.10.3.deb dest=~/scala-2.10.3.deb
    - name: install scala
      shell: dpkg -E -i ~/scala-2.10.3.deb
    - name: download typesafe activator
      get_url: url=http://downloads.typesafe.com/typesafe-activator/1.0.13/typesafe-activator-1.0.13.zip dest=~/typesafe-activator-1.0.13.zip
    - name: unzip typesafe activator
      shell: unzip -d /opt/ ~/typesafe-activator-1.0.13.zip
    - name: symlink typesafe activator
      file: src=/opt/activator-1.0.13/activator dest=/usr/local/bin/activator owner=root group=root state=link
    - name: copy static files
      copy: src=../www dest=/var owner=www-data group=www-data
    - name: configure nginx
      template: src=templates/nginx.conf.j2 dest=/etc/nginx/nginx.conf owner=root mode=0644
      notify:
      - restart nginx
    - name: ensure nginx is running
      service: name=nginx state=started
  handlers:
    - name: restart nginx
      service: name=nginx state=restarted
    - name: restore iptables
      shell: iptables-restore < /etc/iptables.rules
    - name: restart fail2ban
      service: name=fail2ban state=restarted

