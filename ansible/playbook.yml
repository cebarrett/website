---
- hosts: all
  remote_user: root
  tasks:
    - name: configure iptables
      template: src=templates/iptables.j2 dest=/etc/iptables.rules
      notify:
      - restore iptables
    - name: upgrade nginx
      apt: pkg=nginx state=latest 
      notify:
      - restart nginx
    - name: copy static files
      copy: src=../www dest=/var owner=www-data group=www-data
    - name: configure nginx
      template: src=templates/nginx.conf.j2 dest=/etc/nginx/nginx.conf owner=root mode=0644
      notify:
      - restart nginx
    - name: ensure nginx is running
      service: name=nginx state=started
  handlers:
    - name: restart nginx
      service: name=nginx state=restarted
    - name: restore iptables
      shell: iptables-restore < /etc/iptables.rules

